name: Release Pipeline

# æ‰‹åŠ¨è§¦å‘ï¼ŒæŒ‡å®šç‰ˆæœ¬å·
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å·ï¼ˆå¦‚ v1.0.1ï¼‰'
        required: true
      build_branch:
        description: 'Build åˆ†æ”¯åï¼ˆå¦‚ build-v1.0.1ï¼‰'
        required: true
        default: 'build'
      create_github_release:
        description: 'æ˜¯å¦åˆ›å»º GitHub Release'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write

jobs:
  # éªŒè¯è¾“å…¥
  validate:
    name: éªŒè¯å‘å¸ƒå‚æ•°
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.validate.outputs.version }}
      version_clean: ${{ steps.validate.outputs.version_clean }}
      build_branch: ${{ steps.validate.outputs.build_branch }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: è¯»å–å¹¶éªŒè¯ç‰ˆæœ¬ä¿¡æ¯
        id: validate
        run: |
          BUILD_BRANCH="${{ github.event.inputs.build_branch }}"
          
          # æ£€æŸ¥ build åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if ! git ls-remote --heads origin "$BUILD_BRANCH" | grep -q "$BUILD_BRANCH"; then
            echo "âŒ é”™è¯¯: Build åˆ†æ”¯ '$BUILD_BRANCH' ä¸å­˜åœ¨"
            echo "ðŸ’¡ æç¤º: è¯·å…ˆè¿è¡Œ Build Pipeline åˆ›å»ºæž„å»º"
            exit 1
          fi
          
          # ä»Ž build åˆ†æ”¯è¯»å– version.json
          git fetch origin "$BUILD_BRANCH:$BUILD_BRANCH" || true
          git checkout "$BUILD_BRANCH" || git checkout -b "$BUILD_BRANCH" origin/"$BUILD_BRANCH"
          
          if [ ! -f "version.json" ]; then
            echo "âŒ é”™è¯¯: build åˆ†æ”¯ä¸­æœªæ‰¾åˆ° version.json æ–‡ä»¶"
            exit 1
          fi
          
          VERSION=$(cat version.json | grep -o '"version"[[:space:]]*:[[:space:]]*"[^"]*"' | cut -d'"' -f4)
          if [ -z "$VERSION" ]; then
            echo "âŒ é”™è¯¯: version.json ä¸­æœªæ‰¾åˆ° version å­—æ®µ"
            exit 1
          fi
          
          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ é”™è¯¯: version.json ä¸­çš„ç‰ˆæœ¬å·æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º v1.0.1 æ ¼å¼"
            echo "   å½“å‰å€¼: $VERSION"
            exit 1
          fi
          
          # ç§»é™¤ v å‰ç¼€
          VERSION_CLEAN="${VERSION#v}"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_clean=$VERSION_CLEAN" >> $GITHUB_OUTPUT
          echo "build_branch=$BUILD_BRANCH" >> $GITHUB_OUTPUT
          
          echo "âœ… éªŒè¯é€šè¿‡"
          echo "ðŸ“Œ ç‰ˆæœ¬å·ï¼ˆæ¥è‡ª version.jsonï¼‰: $VERSION"
          echo "ðŸŒ¿ Build åˆ†æ”¯: $BUILD_BRANCH"

  # åˆ›å»º Release åˆ†æ”¯
  create-release-branches:
    name: åˆ›å»º Release åˆ†æ”¯
    needs: validate
    runs-on: ubuntu-latest
    outputs:
      release_latest: ${{ steps.branches.outputs.release_latest }}
      release_versioned: ${{ steps.branches.outputs.release_versioned }}
    
    steps:
      - name: Checkout build åˆ†æ”¯
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate.outputs.build_branch }}
          fetch-depth: 0
      
      - name: é…ç½® Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: åˆ›å»º ReleaseLatest åˆ†æ”¯
        id: branches
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          BUILD_BRANCH="${{ needs.validate.outputs.build_branch }}"
          
          echo "ðŸ“¦ åŸºäºŽ $BUILD_BRANCH åˆ›å»º Release åˆ†æ”¯..."
          
          # 1. åˆ›å»º/æ›´æ–° ReleaseLatest åˆ†æ”¯
          echo "ðŸ”„ åˆ›å»º/æ›´æ–° ReleaseLatest åˆ†æ”¯..."
          git checkout -B ReleaseLatest
          
          # æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯åˆ°åˆ†æ”¯
          echo "$VERSION" > .release-version
          git add .release-version
          git commit -m "chore: update to version $VERSION" || true
          
          git push -f origin ReleaseLatest
          echo "âœ… ReleaseLatest åˆ†æ”¯å·²æ›´æ–°"
          
          # 2. åˆ›å»ºç‰ˆæœ¬åŒ–çš„ Release åˆ†æ”¯
          VERSIONED_BRANCH="Release_$VERSION"
          echo "ðŸ”„ åˆ›å»º $VERSIONED_BRANCH åˆ†æ”¯..."
          git checkout -B "$VERSIONED_BRANCH"
          git push -f origin "$VERSIONED_BRANCH"
          echo "âœ… $VERSIONED_BRANCH åˆ†æ”¯å·²åˆ›å»º"
          
          echo "release_latest=ReleaseLatest" >> $GITHUB_OUTPUT
          echo "release_versioned=$VERSIONED_BRANCH" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ðŸŽ‰ Release åˆ†æ”¯åˆ›å»ºå®Œæˆï¼"
          echo "  - ReleaseLatest: https://github.com/${{ github.repository }}/tree/ReleaseLatest"
          echo "  - $VERSIONED_BRANCH: https://github.com/${{ github.repository }}/tree/$VERSIONED_BRANCH"

  # ä¸‹è½½ Build Pipeline çš„æž„å»ºäº§ç‰©
  download-build-artifacts:
    name: ä¸‹è½½æž„å»ºäº§ç‰©
    needs: [validate]
    runs-on: ubuntu-latest
    
    steps:
      - name: æŸ¥æ‰¾ Build Pipeline çš„æœ€æ–°è¿è¡Œ
        id: find-build
        run: |
          BUILD_BRANCH="${{ needs.validate.outputs.build_branch }}"
          
          echo "ðŸ” æŸ¥æ‰¾ Build Pipeline åœ¨åˆ†æ”¯ '$BUILD_BRANCH' ä¸Šçš„æœ€æ–°æˆåŠŸè¿è¡Œ..."
          
          # æŸ¥æ‰¾å¯¹åº” build åˆ†æ”¯çš„æœ€æ–°æˆåŠŸè¿è¡Œ
          BUILD_RUN=$(gh run list --workflow=build.yml --branch "$BUILD_BRANCH" --status success --limit 1 --json databaseId --jq '.[0].databaseId' || echo "")
          
          if [ -z "$BUILD_RUN" ] || [ "$BUILD_RUN" = "null" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° Build Pipeline åœ¨åˆ†æ”¯ '$BUILD_BRANCH' ä¸Šçš„æˆåŠŸè¿è¡Œ"
            echo "ðŸ’¡ æç¤º: è¯·å…ˆè¿è¡Œ Build Pipeline å¹¶ç¡®ä¿æž„å»ºæˆåŠŸ"
            echo "ðŸ’¡ æç¤º: Build Pipeline åº”è¯¥åœ¨åˆ†æ”¯ '$BUILD_BRANCH' ä¸Šè¿è¡Œ"
            exit 1
          fi
          
          echo "build_run_id=$BUILD_RUN" >> $GITHUB_OUTPUT
          echo "âœ… æ‰¾åˆ° Build Pipeline è¿è¡Œ: $BUILD_RUN"
          echo "ðŸ”— è¿è¡Œé“¾æŽ¥: https://github.com/${{ github.repository }}/actions/runs/$BUILD_RUN"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ steps.find-build.outputs.build_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: build-artifacts
      
      - name: æ•´ç†æž„å»ºäº§ç‰©
        run: |
          echo "ðŸ“¦ åŽŸå§‹æž„å»ºäº§ç‰©åˆ—è¡¨:"
          find build-artifacts -type f | sort || true
          
          # åˆ›å»ºç»Ÿä¸€ç›®å½•
          mkdir -p release-artifacts
          
          # å¤åˆ¶æ‰€æœ‰ cursortoolset-* æ–‡ä»¶ï¼ˆåŒ…æ‹¬äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ ¡éªŒå’Œï¼‰
          find build-artifacts -type f \( -name "cursortoolset-*" -o -name "*.sha256" \) -exec cp {} release-artifacts/ \;
          
          echo ""
          echo "âœ… æ•´ç†åŽçš„æž„å»ºäº§ç‰©:"
          ls -lh release-artifacts/ | sort
          
          # éªŒè¯æ–‡ä»¶æ•°é‡ï¼ˆåº”è¯¥æœ‰ 10 ä¸ªæ–‡ä»¶ï¼š5 ä¸ªäºŒè¿›åˆ¶ + 5 ä¸ªæ ¡éªŒå’Œï¼‰
          FILE_COUNT=$(find release-artifacts -type f | wc -l)
          echo "ðŸ“Š æ–‡ä»¶æ€»æ•°: $FILE_COUNT"
          
          if [ "$FILE_COUNT" -lt 5 ]; then
            echo "âš ï¸  è­¦å‘Š: æ–‡ä»¶æ•°é‡å°‘äºŽé¢„æœŸï¼ˆè‡³å°‘åº”è¯¥æœ‰ 5 ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼‰"
          fi
      
      - name: ä¸Šä¼ æ•´ç†åŽçš„äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: release-binaries
          path: release-artifacts/*
          retention-days: 1

  # åˆ›å»º GitHub Release
  create-github-release:
    name: åˆ›å»º GitHub Release
    needs: [validate, create-release-branches, download-build-artifacts]
    if: github.event.inputs.create_github_release == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ReleaseLatest
        uses: actions/checkout@v4
        with:
          ref: ReleaseLatest
          fetch-depth: 0
      
      - name: ä¸‹è½½æ•´ç†åŽçš„æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: release-binaries
          path: release-files/binaries
      
      - name: æ•´ç† Release æ–‡ä»¶
        run: |
          mkdir -p release-files
          
          # ç§»åŠ¨æž„å»ºäº§ç‰©åˆ° release-files
          if [ -d "release-files/binaries" ]; then
            mv release-files/binaries/* release-files/ 2>/dev/null || true
            rmdir release-files/binaries 2>/dev/null || true
          fi
          
          # å¤åˆ¶å®‰è£…è„šæœ¬
          cp install.sh release-files/ 2>/dev/null || true
          cp install.ps1 release-files/ 2>/dev/null || true
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          cp available-toolsets.json release-files/ 2>/dev/null || true
          
          echo "ðŸ“¦ Release æ–‡ä»¶åˆ—è¡¨:"
          ls -lh release-files/
      
      - name: ç”Ÿæˆ toolset.json è‡ªæè¿°æ–‡ä»¶
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          
          # è¯»å–çŽ°æœ‰çš„ toolset.jsonï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          if [ -f "toolset.json" ]; then
            # ä½¿ç”¨ jq æ›´æ–°ç‰ˆæœ¬å·ï¼ˆå¦‚æžœå®‰è£…äº† jqï¼‰
            if command -v jq >/dev/null 2>&1; then
              jq ".version = \"$VERSION\"" toolset.json > release-files/toolset.json
            else
              # ä½¿ç”¨ sed æ›´æ–°ç‰ˆæœ¬å·
              sed "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" toolset.json > release-files/toolset.json
            fi
          else
            # ç”ŸæˆåŸºæœ¬çš„ toolset.json
            cat > release-files/toolset.json << TOOLSET_EOF
          {
            "name": "cursortoolset",
            "displayName": "Cursor å·¥å…·é›†ç®¡ç†å™¨",
            "version": "$VERSION",
            "description": "ä¸€ä¸ªç±»ä¼¼ Homebrew çš„å·¥å…·é›†ç®¡ç†å™¨ï¼Œä¸“é—¨ä¸º Cursor IDE è®¾è®¡",
            "author": "firoyang",
            "license": "MIT",
            "keywords": ["cursor", "toolset", "ai-tools", "package-manager"],
            "repository": {
              "type": "git",
              "url": "https://github.com/${{ github.repository }}.git"
            },
            "metadata": {
              "created": "$(date -u '+%Y-%m-%d')",
              "toolset_version": "$VERSION"
            }
          }
          TOOLSET_EOF
          fi
          
          echo "âœ… toolset.json å·²ç”Ÿæˆ"
          cat release-files/toolset.json
      
      - name: ç”Ÿæˆ Release Notes
        id: release-notes
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          
          cat > release-notes.md << EOF
          # CursorToolset $VERSION
          
          ## ðŸ“¦ å®‰è£…æ–¹å¼
          
          ### ä¸€é”®å®‰è£…
          
          #### Linux / macOS
          \`\`\`bash
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/ReleaseLatest/install.sh | bash
          \`\`\`
          
          #### Windows (PowerShell)
          \`\`\`powershell
          iwr -useb https://raw.githubusercontent.com/${{ github.repository }}/ReleaseLatest/install.ps1 | iex
          \`\`\`
          
          ### æ‰‹åŠ¨ä¸‹è½½
          
          ä¸‹è½½é€‚åˆæ‚¨å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè§£åŽ‹å¹¶æ·»åŠ åˆ° PATHã€‚
          
          ## ðŸ” æ ¡éªŒæ–‡ä»¶
          
          æ¯ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶éƒ½æœ‰å¯¹åº”çš„ .sha256 æ ¡éªŒæ–‡ä»¶ã€‚
          
          \`\`\`bash
          # Linux/macOS
          sha256sum -c cursortoolset-linux-amd64.sha256
          
          # Windows (PowerShell)
          \$expected = Get-Content cursortoolset-windows-amd64.exe.sha256 | %{(\$_ -split ' ')[0]}
          \$actual = (Get-FileHash cursortoolset-windows-amd64.exe -Algorithm SHA256).Hash
          \$expected -eq \$actual
          \`\`\`
          
          ## ðŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
          
          - **ç‰ˆæœ¬å·**: $VERSION
          - **å‘å¸ƒæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **æäº¤**: ${{ github.sha }}
          
          ## ðŸ”— ç›¸å…³é“¾æŽ¥
          
          - **ReleaseLatest åˆ†æ”¯**: https://github.com/${{ github.repository }}/tree/ReleaseLatest
          - **å½’æ¡£åˆ†æ”¯**: https://github.com/${{ github.repository }}/tree/Release_$VERSION
          - **æ–‡æ¡£**: https://github.com/${{ github.repository }}/blob/ReleaseLatest/README.md
          
          ## ðŸ“ æ›´æ–°æ—¥å¿—
          
          è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/ReleaseLatest/CHANGELOG.md)
          EOF
          
          cat release-notes.md
      
      - name: åˆ›å»º Git Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          VERSION="${{ needs.validate.outputs.version }}"
          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"
      
      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate.outputs.version }}
          name: CursorToolset ${{ needs.validate.outputs.version }}
          body_path: release-notes.md
          files: release-files/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # å‘å¸ƒæ€»ç»“
  release-summary:
    name: å‘å¸ƒæ€»ç»“
    needs: [validate, create-release-branches, download-build-artifacts, create-github-release]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: ç”Ÿæˆå‘å¸ƒæ€»ç»“
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          
          echo "# ðŸŽ‰ Release Pipeline å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ å‘å¸ƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Build åˆ†æ”¯**: ${{ needs.validate.outputs.build_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å‘å¸ƒæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŒ¿ åˆ›å»ºçš„åˆ†æ”¯" >> $GITHUB_STEP_SUMMARY
          echo "1. **ReleaseLatest**: [æŸ¥çœ‹åˆ†æ”¯](https://github.com/${{ github.repository }}/tree/ReleaseLatest)" >> $GITHUB_STEP_SUMMARY
          echo "   - ç”¨é€”: ä¸€é”®å®‰è£…è„šæœ¬çš„å›ºå®šé“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "   - æ›´æ–°: æ¯æ¬¡å‘å¸ƒéƒ½ä¼šæ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **Release_$VERSION**: [æŸ¥çœ‹åˆ†æ”¯](https://github.com/${{ github.repository }}/tree/Release_$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "   - ç”¨é€”: å½’æ¡£æ­¤ç‰ˆæœ¬çš„ä»£ç " >> $GITHUB_STEP_SUMMARY
          echo "   - æ›´æ–°: æ°¸ä¹…ä¿ç•™ï¼Œä¸ä¼šå˜æ›´" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.create_github_release }}" = "true" ]; then
            echo "## ðŸš€ GitHub Release" >> $GITHUB_STEP_SUMMARY
            echo "[ç‚¹å‡»æŸ¥çœ‹ Release $VERSION](https://github.com/${{ github.repository }}/releases/tag/$VERSION)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "## ðŸ“¥ å®‰è£…å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Linux / macOS" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/ReleaseLatest/install.sh | bash" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Windows (PowerShell)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`powershell" >> $GITHUB_STEP_SUMMARY
          echo "iwr -useb https://raw.githubusercontent.com/${{ github.repository }}/ReleaseLatest/install.ps1 | iex" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… å‘å¸ƒçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "æ‰€æœ‰æ­¥éª¤å·²å®Œæˆï¼" >> $GITHUB_STEP_SUMMARY

